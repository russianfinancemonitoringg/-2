<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отзывы - Сервис отзывов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Общие стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Шапка с авторизацией */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        /* Хлебные крошки */
        .breadcrumbs {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #1e1e1e;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .breadcrumb {
            background: none;
            border: none;
            color: #64b5f6;
            font-size: 16px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .breadcrumb:hover {
            background-color: #2d2d2d;
            color: #90caf9;
        }

        .separator {
            margin: 0 10px;
            color: #666;
        }

        /* Заголовки */
        h1 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: #aaa;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Карточки */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .card {
            background-color: #1e1e1e;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            border: 1px solid #333;
            cursor: pointer;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-color: #64b5f6;
        }

        .category-card i {
            font-size: 3rem;
            color: #64b5f6;
            margin-bottom: 15px;
        }

        .category-card h3 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .category-card p {
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Кнопки */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background-color: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1565c0;
        }

        .btn-secondary {
            background-color: #424242;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #555;
        }

        .btn-success {
            background-color: #2e7d32;
            color: white;
            margin-top: 20px;
            width: 100%;
        }

        .btn-success:hover {
            background-color: #1b5e20;
        }

        .btn-danger {
            background-color: #c62828;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b71c1c;
        }

        .btn-warning {
            background-color: #f57c00;
            color: white;
        }

        .btn-warning:hover {
            background-color: #ef6c00;
        }

        /* Секции формы */
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .form-section:last-of-type {
            border-bottom: none;
        }
        
        .form-section-title {
            color: #64b5f6;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Форма отзыва - НОВЫЙ ДИЗАЙН (белая карточка) */
        .review-form-card {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            color: #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .review-form-title {
            color: #1976d2;
            margin-bottom: 25px;
            font-size: 1.8rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #444;
            font-weight: 600;
            font-size: 1rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            color: #333;
            font-size: 16px;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1976d2;
            background-color: #fff;
        }

        /* Рейтинг - новые большие звезды */
        .rating-section {
            text-align: center;
            padding: 20px 0;
        }

        .rating-large {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .star-large {
            font-size: 3rem;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star-large:hover,
        .star-large.active {
            color: #ffc107;
            transform: scale(1.1);
        }

        .rating-text {
            margin-top: 10px;
            color: #666;
            font-size: 1rem;
        }

        /* Загрузка фото */
        .photo-upload-section {
            text-align: center;
        }

        .photo-upload-btn {
            background-color: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .photo-upload-btn:hover {
            border-color: #1976d2;
            background-color: #f0f7ff;
        }

        .photo-upload-icon {
            font-size: 3rem;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .file-input {
            display: none;
        }

        .photos-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .photo-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Поиск */
        .search-container {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex-grow: 1;
            padding: 12px 20px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 16px;
        }

        .search-button {
            padding: 12px 25px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .search-button:hover {
            background-color: #1565c0;
        }

        .clear-search {
            padding: 12px 15px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Таблица отзывов */
        .reviews-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .reviews-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #1e1e1e;
            border-radius: 10px;
            overflow: hidden;
        }

        .reviews-table th {
            background-color: #1976d2;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .reviews-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            color: #e0e0e0;
        }

        .reviews-table tr:hover {
            background-color: #2d2d2d;
        }

        .address-link {
            color: #64b5f6;
            cursor: pointer;
            text-decoration: underline;
        }

        .address-link:hover {
            color: #90caf9;
        }

        .rating-stars {
            color: #ffc107;
        }

        /* Фото в таблице */
        .review-photo-cell {
            text-align: center;
        }
        
        .review-photo-thumb {
            max-width: 80px;
            max-height: 60px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .review-photo-thumb:hover {
            transform: scale(1.8);
            z-index: 100;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            border: 1px solid #333;
            position: relative;
            color: #333;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #1976d2;
        }

        .close-modal {
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #000;
        }

        /* Модальное окно для фото */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }
        
        .photo-modal-content {
            max-width: 90%;
            max-height: 90%;
        }
        
        .close-photo-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Админ-панель */
        .admin-panel {
            margin-top: 40px;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .user-list, .pending-users {
            margin-top: 15px;
        }

        .user-item, .pending-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #2d2d2d;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .admin-badge {
            background-color: #1976d2;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #1976d2;
            color: white;
            border-radius: 8px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .notification-success {
            background-color: #2e7d32;
        }

        .notification-error {
            background-color: #c62828;
        }

        .notification-warning {
            background-color: #f57c00;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .cards {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .reviews-table {
                font-size: 0.9rem;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .auth-buttons {
                width: 100%;
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .star-large {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 480px) {
            .breadcrumbs {
                font-size: 0.9rem;
            }
            
            .user-item, .pending-user-item {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .user-actions {
                width: 100%;
            }
            
            .star-large {
                font-size: 2rem;
                gap: 10px;
            }
            
            .review-form-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка с авторизацией -->
        <div class="header">
            <div class="logo">
                <h1><i class="fas fa-star"></i> Отзывы</h1>
            </div>
            <div class="auth-buttons" id="auth-buttons">
                <button class="btn btn-primary" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Войти
                </button>
                <button class="btn btn-secondary" id="register-btn">
                    <i class="fas fa-user-plus"></i> Регистрация
                </button>
            </div>
            <div id="user-info" style="display: none;">
                <span id="user-email" style="margin-right: 15px; color: #64b5f6; font-weight: 600;"></span>
                <button class="btn btn-secondary" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
                <button class="btn btn-warning" id="admin-panel-btn" style="display: none; margin-left: 10px;">
                    <i class="fas fa-cog"></i> Админ-панель
                </button>
            </div>
        </div>

        <!-- Верхняя навигация (хлебные крошки) -->
        <nav class="breadcrumbs">
            <button class="breadcrumb" data-level="home">Главная</button>
            <span class="separator">/</span>
            <button class="breadcrumb" data-level="category" style="display: none;">Категория</button>
            <span class="separator" style="display: none;">/</span>
            <button class="breadcrumb" data-level="organization" style="display: none;">Организация</button>
            <span class="separator" style="display: none;">/</span>
            <button class="breadcrumb" data-level="city" style="display: none;">Город</button>
        </nav>

        <!-- Основное содержимое -->
        <main id="content">
            <!-- Уровень 1: Главная страница - Категории -->
            <div class="level" id="level-home">
                <h1><i class="fas fa-star"></i> Отзывы</h1>
                <p class="subtitle">Выберите категорию для просмотра отзывов</p>
                
                <div class="cards">
                    <div class="card category-card" data-category="bank">
                        <i class="fas fa-university"></i>
                        <h3>Банк</h3>
                        <p>Отзывы о банках и финансовых услугах</p>
                    </div>
                    
                    <div class="card category-card" data-category="cars">
                        <i class="fas fa-car"></i>
                        <h3>Тачки</h3>
                        <p>Отзывы об автомобилях и автосервисах</p>
                    </div>
                </div>
            </div>

            <!-- Уровень 2: Категория - Организации -->
            <div class="level" id="level-category" style="display: none;">
                <h1 id="category-title"></h1>
                <p class="subtitle">Выберите организацию</p>
                
                <div class="cards" id="organizations-container"></div>
                
                <button class="btn btn-success" id="add-organization-btn">
                    <i class="fas fa-plus-circle"></i> <span id="add-org-text"></span>
                </button>
            </div>

            <!-- Уровень 3: Организация - Города -->
            <div class="level" id="level-organization" style="display: none;">
                <h1 id="organization-title"></h1>
                <p class="subtitle">Выберите город</p>
                
                <div class="cards" id="cities-container"></div>
                
                <button class="btn btn-success" id="add-city-btn">
                    <i class="fas fa-plus-circle"></i> Добавить город
                </button>
            </div>

            <!-- Уровень 4: Город - Отзывы -->
            <div class="level" id="level-city" style="display: none;">
                <h1 id="city-title"></h1>
                <p class="subtitle" id="city-subtitle"></p>
                
                <!-- НОВАЯ ФОРМА ДЛЯ ОТЗЫВА -->
                <div class="review-form-card" id="review-form-container" style="display: none;">
                    <h2 class="review-form-title">Оставить отзыв</h2>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-star"></i>
                            <span>Ваша оценка</span>
                        </div>
                        <div class="rating-section">
                            <div class="rating-large" id="rating-large">
                                <span class="star-large" data-value="1">★</span>
                                <span class="star-large" data-value="2">★</span>
                                <span class="star-large" data-value="3">★</span>
                                <span class="star-large" data-value="4">★</span>
                                <span class="star-large" data-value="5">★</span>
                            </div>
                            <div class="rating-text" id="rating-text">Нажмите на звезду для оценки</div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-comment"></i>
                            <span>Ваш отзыв</span>
                        </div>
                        <div class="form-group">
                            <textarea id="review-text" placeholder="Поделитесь своим опытом..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-camera"></i>
                            <span>Фото</span>
                        </div>
                        <div class="photo-upload-section">
                            <label class="photo-upload-btn" id="photo-upload-label">
                                <i class="fas fa-camera photo-upload-icon"></i>
                                <div>Добавить фото</div>
                                <input type="file" id="review-photo" class="file-input" accept="image/*" multiple>
                            </label>
                            <div class="photos-preview" id="photos-preview"></div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Адрес</span>
                        </div>
                        <div class="form-group">
                            <input type="text" id="review-address" placeholder="Укажите адрес (например, ул. Ленина, д. 15)">
                        </div>
                    </div>
                    
                    <button id="submit-review" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 1.2rem;">
                        <i class="fas fa-paper-plane"></i> Опубликовать отзыв
                    </button>
                    
                    <div id="captcha-notice" style="margin-top: 15px; text-align: center; color: #888; font-size: 0.9rem;">
                        <i class="fas fa-shield-alt"></i> Для защиты от спама все отзывы проходят модерацию
                    </div>
                </div>
                
                <div id="login-to-review" class="card" style="text-align: center;">
                    <h3><i class="fas fa-lock"></i> Войдите, чтобы оставить отзыв</h3>
                    <p>Только авторизованные пользователи могут добавлять отзывы</p>
                    <button class="btn btn-primary" id="login-from-review">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                </div>
                
                <!-- Поиск по адресам -->
                <div class="search-container" id="search-container" style="display: none;">
                    <input type="text" id="address-search" class="search-input" placeholder="Поиск по адресу...">
                    <button id="search-button" class="search-button">
                        <i class="fas fa-search"></i> Найти
                    </button>
                    <button id="clear-search" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Сбросить
                    </button>
                </div>
                
                <!-- Таблица отзывов -->
                <div class="reviews-table-container">
                    <h3><i class="fas fa-comments"></i> <span id="reviews-title"></span></h3>
                    <div id="address-filter-info" style="margin: 10px 0; color: #64b5f6; display: none;">
                        <i class="fas fa-filter"></i> Показаны отзывы по адресу: <span id="current-address-filter"></span>
                        <button id="clear-address-filter" class="btn btn-secondary" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-times"></i> Показать все
                        </button>
                    </div>
                    <table class="reviews-table" id="reviews-table">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Адрес</th>
                                <th>Отзыв</th>
                                <th>Фото</th>
                                <th>Оценка</th>
                                <th>Пользователь</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="reviews-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- Админ-панель -->
            <div class="level" id="level-admin" style="display: none;">
                <h1><i class="fas fa-cog"></i> Админ-панель</h1>
                <div class="admin-panel" id="admin-panel-content"></div>
            </div>
        </main>
    </div>

    <!-- Модальные окна -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-sign-in-alt"></i> Вход</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" placeholder="Введите ваш email">
            </div>
            <div class="form-group">
                <label for="login-password">Пароль:</label>
                <input type="password" id="login-password" placeholder="Введите ваш пароль">
            </div>
            <button id="do-login" class="btn btn-primary">Войти</button>
        </div>
    </div>

    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Регистрация</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="register-email">Email:</label>
                <input type="email" id="register-email" placeholder="Введите ваш email">
            </div>
            <div class="form-group">
                <label for="register-password">Пароль:</label>
                <input type="password" id="register-password" placeholder="Придумайте пароль">
            </div>
            <div class="form-group">
                <label for="register-confirm">Подтвердите пароль:</label>
                <input type="password" id="register-confirm" placeholder="Повторите пароль">
            </div>
            <button id="do-register" class="btn btn-primary">Зарегистрироваться</button>
            <p style="margin-top: 15px; color: #aaa; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> После регистрации администратор подтвердит ваш аккаунт
            </p>
        </div>
    </div>

    <!-- Уведомление -->
    <div id="notification" class="notification" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span id="notification-text"></span>
    </div>

    <script>
        // ==================== ДАННЫЕ ПРИЛОЖЕНИЯ ====================
        const appData = {
            categories: {
                bank: {
                    name: "Банк",
                    icon: "fa-university",
                    organizations: {
                        sber: {
                            name: "СберБанк",
                            cities: ["Москва", "Санкт-Петербург", "Екатеринбург", "Казань", "Новосибирск"]
                        },
                        vtb: {
                            name: "ВТБ",
                            cities: ["Москва", "Санкт-Петербург", "Краснодар", "Сочи", "Ростов-на-Дону"]
                        },
                        alpha: {
                            name: "Альфа-Банк",
                            cities: ["Москва", "Санкт-Петербург", "Нижний Новгород", "Самара", "Уфа"]
                        },
                        tinkoff: {
                            name: "Тинькофф",
                            cities: ["Москва", "Санкт-Петербург", "Екатеринбург", "Казань", "Владивосток"]
                        }
                    }
                },
                cars: {
                    name: "Тачки",
                    icon: "fa-car",
                    organizations: {
                        toyota: {
                            name: "Toyota",
                            cities: ["Москва", "Санкт-Петербург", "Красноярск", "Омск", "Тюмень"]
                        },
                        bmw: {
                            name: "BMW",
                            cities: ["Москва", "Санкт-Петербург", "Калининград", "Воронеж", "Иркутск"]
                        },
                        lada: {
                            name: "Lada",
                            cities: ["Москва", "Санкт-Петербург", "Тольятти", "Челябинск", "Волгоград"]
                        }
                    }
                }
            },
            reviews: [
                {
                    id: 1,
                    category: "bank",
                    organization: "sber",
                    city: "Москва",
                    text: "Отличный банк, хорошее обслуживание. Рекомендую!",
                    address: "ул. Тверская, д. 15",
                    photos: [],
                    rating: 5,
                    date: "2023-10-15",
                    user: "user1@example.com",
                    status: "approved"
                },
                {
                    id: 2,
                    category: "bank",
                    organization: "sber",
                    city: "Санкт-Петербург",
                    text: "Долго ждал в очереди, но менеджер помог решить вопрос.",
                    address: "Невский пр., д. 25",
                    photos: [],
                    rating: 3,
                    date: "2023-10-10",
                    user: "user2@example.com",
                    status: "approved"
                },
                {
                    id: 3,
                    category: "cars",
                    organization: "toyota",
                    city: "Москва",
                    text: "Качественный сервис, все сделали быстро и профессионально.",
                    address: "ул. Ленина, д. 42",
                    photos: [],
                    rating: 4,
                    date: "2023-10-05",
                    user: "user3@example.com",
                    status: "approved"
                }
            ],
            users: [
                {
                    id: 1,
                    email: "antonov1.alexandr1@gmail.com",
                    password: "bolonka192939",
                    role: "admin",
                    status: "active",
                    registered: "2023-01-01"
                },
                {
                    id: 2,
                    email: "user1@example.com",
                    password: "password1",
                    role: "user",
                    status: "active",
                    registered: "2023-09-01"
                },
                {
                    id: 3,
                    email: "user2@example.com",
                    password: "password2",
                    role: "user",
                    status: "active",
                    registered: "2023-09-15"
                }
            ],
            pendingUsers: []
        };

        // ==================== СОСТОЯНИЕ ПРИЛОЖЕНИЯ ====================
        let currentState = {
            level: "home",
            category: null,
            organization: null,
            city: null,
            selectedRating: 0,
            currentUser: null,
            addressFilter: null,
            selectedPhotos: []
        };

        // ==================== УТИЛИТЫ ====================
        function showNotification(message, type = "info") {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notification-text');
            
            text.textContent = message;
            notification.className = `notification notification-${type}`;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function generateId() {
            return Date.now() + Math.floor(Math.random() * 1000);
        }

        // ==================== АВТОРИЗАЦИЯ ====================
        function updateAuthUI() {
            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            const reviewForm = document.getElementById('review-form-container');
            const loginToReview = document.getElementById('login-to-review');
            
            if (currentState.currentUser) {
                authButtons.style.display = 'none';
                userInfo.style.display = 'block';
                userEmail.textContent = currentState.currentUser.email;
                
                if (currentState.currentUser.role === 'admin') {
                    adminPanelBtn.style.display = 'inline-block';
                } else {
                    adminPanelBtn.style.display = 'none';
                }
                
                if (currentState.level === 'city') {
                    reviewForm.style.display = 'block';
                    loginToReview.style.display = 'none';
                }
            } else {
                authButtons.style.display = 'flex';
                userInfo.style.display = 'none';
                
                if (currentState.level === 'city') {
                    reviewForm.style.display = 'none';
                    loginToReview.style.display = 'block';
                }
            }
        }

        function login(email, password) {
            const user = appData.users.find(u => 
                u.email === email && u.password === password && u.status === 'active'
            );
            
            const pendingUser = appData.pendingUsers.find(u =>
                u.email === email && u.password === password
            );
            
            if (user) {
                currentState.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                updateAuthUI();
                showNotification('Вы успешно вошли в систему!', 'success');
                closeModal('login-modal');
                return true;
            } else if (pendingUser) {
                showNotification('Ваш аккаунт еще не подтвержден администратором', 'warning');
                return false;
            } else {
                showNotification('Неверный email или пароль', 'error');
                return false;
            }
        }

        function logout() {
            currentState.currentUser = null;
            localStorage.removeItem('currentUser');
            updateAuthUI();
            showNotification('Вы вышли из системы', 'info');
            
            if (currentState.level === 'admin') {
                navigateToLevel('home');
            }
        }

        function register(email, password) {
            const existingUser = appData.users.find(u => u.email === email);
            const existingPending = appData.pendingUsers.find(u => u.email === email);
            
            if (existingUser || existingPending) {
                showNotification('Пользователь с таким email уже существует', 'error');
                return false;
            }
            
            const newUser = {
                id: generateId(),
                email: email,
                password: password,
                role: "user",
                status: "pending",
                registered: new Date().toISOString().split('T')[0]
            };
            
            appData.pendingUsers.push(newUser);
            showNotification('Регистрация успешна! Ожидайте подтверждения администратора', 'success');
            closeModal('register-modal');
            
            notifyAdminAboutNewUser(newUser);
            
            return true;
        }

        function notifyAdminAboutNewUser(user) {
            console.log(`Новый пользователь ожидает подтверждения: ${user.email}`);
            
            if (currentState.currentUser && currentState.currentUser.role === 'admin') {
                showNotification(`Новый пользователь: ${user.email} ожидает подтверждения`, 'warning');
                if (currentState.level === 'admin') {
                    renderAdminPanel();
                }
            }
        }

        // ==================== ИНИЦИАЛИЗАЦИЯ И ОБРАБОТЧИКИ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Восстанавливаем пользователя из localStorage
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentState.currentUser = JSON.parse(savedUser);
                } catch (e) {
                    console.error('Ошибка при загрузке пользователя из localStorage:', e);
                    localStorage.removeItem('currentUser');
                }
            }
            
            // Обновляем интерфейс
            updateAuthUI();
            
            // Обработчики для кнопок Войти и Регистрация
            document.getElementById('login-btn').addEventListener('click', function() {
                console.log('Кнопка Войти нажата');
                openModal('login-modal');
            });
            
            document.getElementById('register-btn').addEventListener('click', function() {
                console.log('Кнопка Регистрация нажата');
                openModal('register-modal');
            });
            
            document.getElementById('login-from-review').addEventListener('click', function() {
                openModal('login-modal');
            });
            
            // Вход
            document.getElementById('do-login').addEventListener('click', function() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value.trim();
                
                if (email && password) {
                    login(email, password);
                } else {
                    showNotification('Заполните все поля', 'error');
                }
            });
            
            // Регистрация
            document.getElementById('do-register').addEventListener('click', function() {
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value.trim();
                const confirm = document.getElementById('register-confirm').value.trim();
                
                if (!email || !password || !confirm) {
                    showNotification('Заполните все поля', 'error');
                    return;
                }
                
                if (password !== confirm) {
                    showNotification('Пароли не совпадают', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showNotification('Пароль должен быть не менее 6 символов', 'error');
                    return;
                }
                
                register(email, password);
            });
            
            // Выход
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Админ-панель
            document.getElementById('admin-panel-btn').addEventListener('click', function() {
                navigateToLevel('admin');
            });
            
            // Закрытие модальных окон
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    closeModal(modal.id);
                });
            });
            
            // Клик вне модального окна
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // Навигация по категориям
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    navigateToCategory(category);
                });
            });
            
            // Хлебные крошки
            document.querySelectorAll('.breadcrumb').forEach(crumb => {
                crumb.addEventListener('click', function() {
                    const level = this.getAttribute('data-level');
                    navigateToLevel(level);
                });
            });
            
            // Рейтинг
            document.querySelectorAll('.star-large').forEach(star => {
                star.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    setRating(value);
                });
            });
            
            // Загрузка фото
            document.getElementById('review-photo').addEventListener('change', handlePhotoUpload);
            
            // Добавление отзыва
            document.getElementById('submit-review').addEventListener('click', addReview);
            
            // Инициализация главной страницы
            renderHomePage();
            updateBreadcrumbs();
        });

        // ==================== НАВИГАЦИЯ ====================
        function navigateToLevel(level) {
            currentState.level = level;
            
            if (level === 'home') {
                currentState.category = null;
                currentState.organization = null;
                currentState.city = null;
                currentState.addressFilter = null;
                renderHomePage();
            } else if (level === 'category') {
                currentState.organization = null;
                currentState.city = null;
                currentState.addressFilter = null;
                renderCategoryPage();
            } else if (level === 'organization') {
                currentState.city = null;
                currentState.addressFilter = null;
                renderOrganizationPage();
            } else if (level === 'city') {
                renderCityPage();
            } else if (level === 'admin') {
                renderAdminPanel();
            }
            
            updateBreadcrumbs();
            updateAuthUI();
        }

        function navigateToCategory(categoryId) {
            currentState.level = 'category';
            currentState.category = categoryId;
            currentState.organization = null;
            currentState.city = null;
            currentState.addressFilter = null;
            
            renderCategoryPage();
            updateBreadcrumbs();
        }

        function navigateToOrganization(orgId) {
            currentState.level = 'organization';
            currentState.organization = orgId;
            currentState.city = null;
            currentState.addressFilter = null;
            
            renderOrganizationPage();
            updateBreadcrumbs();
        }

        function navigateToCity(city) {
            currentState.level = 'city';
            currentState.city = city;
            currentState.addressFilter = null;
            
            renderCityPage();
            updateBreadcrumbs();
        }

        function updateBreadcrumbs() {
            const breadcrumbElements = document.querySelectorAll('.breadcrumb');
            const separatorElements = document.querySelectorAll('.separator');
            
            // Скрываем все крошки и разделители
            breadcrumbElements.forEach((crumb, index) => {
                if (index > 0) crumb.style.display = 'none';
            });
            separatorElements.forEach(sep => sep.style.display = 'none');
            
            // Показываем нужные крошки в зависимости от уровня
            document.querySelector('[data-level="home"]').style.display = 'inline-block';
            
            if (currentState.level === 'category' || currentState.level === 'organization' || currentState.level === 'city') {
                if (currentState.category && appData.categories[currentState.category]) {
                    document.querySelector('[data-level="category"]').style.display = 'inline-block';
                    document.querySelector('[data-level="category"]').textContent = appData.categories[currentState.category].name;
                    separatorElements[0].style.display = 'inline';
                }
            }
            
            if (currentState.level === 'organization' || currentState.level === 'city') {
                if (currentState.category && currentState.organization && 
                    appData.categories[currentState.category] && 
                    appData.categories[currentState.category].organizations[currentState.organization]) {
                    document.querySelector('[data-level="organization"]').style.display = 'inline-block';
                    document.querySelector('[data-level="organization"]').textContent = 
                        appData.categories[currentState.category].organizations[currentState.organization].name;
                    separatorElements[1].style.display = 'inline';
                }
            }
            
            if (currentState.level === 'city') {
                if (currentState.city) {
                    document.querySelector('[data-level="city"]').style.display = 'inline-block';
                    document.querySelector('[data-level="city"]').textContent = currentState.city;
                    separatorElements[2].style.display = 'inline';
                }
            }
        }

        // ==================== РЕНДЕР СТРАНИЦ ====================
        function renderHomePage() {
            document.querySelectorAll('.level').forEach(level => {
                level.style.display = 'none';
            });
            document.getElementById('level-home').style.display = 'block';
        }

        function renderCategoryPage() {
            const category = appData.categories[currentState.category];
            
            if (!category) {
                navigateToLevel('home');
                return;
            }
            
            document.getElementById('category-title').textContent = category.name;
            document.getElementById('category-title').innerHTML = `<i class="fas ${category.icon}"></i> ${category.name}`;
            
            const addOrgText = document.getElementById('add-org-text');
            addOrgText.textContent = currentState.category === 'bank' ? 'Добавить банк' : 
                                    currentState.category === 'cars' ? 'Добавить машину' : 'Добавить организацию';
            
            const container = document.getElementById('organizations-container');
            container.innerHTML = '';
            
            for (const orgId in category.organizations) {
                const org = category.organizations[orgId];
                
                const card = document.createElement('div');
                card.className = 'card category-card';
                card.setAttribute('data-org', orgId);
                card.innerHTML = `
                    <i class="fas fa-building"></i>
                    <h3>${org.name}</h3>
                    <p>${org.cities.length} городов с отзывами</p>
                `;
                
                card.addEventListener('click', () => navigateToOrganization(orgId));
                container.appendChild(card);
            }
            
            document.querySelectorAll('.level').forEach(level => {
                level.style.display = 'none';
            });
            document.getElementById('level-category').style.display = 'block';
        }

        function renderOrganizationPage() {
            const category = appData.categories[currentState.category];
            const org = category.organizations[currentState.organization];
            
            document.getElementById('organization-title').textContent = org.name;
            document.getElementById('organization-title').innerHTML = `<i class="fas fa-building"></i> ${org.name}`;
            
            const container = document.getElementById('cities-container');
            container.innerHTML = '';
            
            org.cities.forEach(city => {
                const card = document.createElement('div');
                card.className = 'card category-card';
                card.innerHTML = `
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>${city}</h3>
                    <p>Отзывы о ${org.name} в ${city}</p>
                `;
                
                card.addEventListener('click', () => navigateToCity(city));
                container.appendChild(card);
            });
            
            document.querySelectorAll('.level').forEach(level => {
                level.style.display = 'none';
            });
            document.getElementById('level-organization').style.display = 'block';
        }

        function renderCityPage() {
            const category = appData.categories[currentState.category];
            const org = category.organizations[currentState.organization];
            
            document.getElementById('city-title').textContent = `${org.name} - ${currentState.city}`;
            document.getElementById('city-subtitle').textContent = `Отзывы о ${org.name} в ${currentState.city}`;
            document.getElementById('reviews-title').textContent = `Отзывы о ${org.name} в ${currentState.city}`;
            
            document.getElementById('search-container').style.display = 'flex';
            displayReviews();
            
            document.querySelectorAll('.level').forEach(level => {
                level.style.display = 'none';
            });
            document.getElementById('level-city').style.display = 'block';
            
            // Сбрасываем форму
            document.getElementById('review-text').value = '';
            document.getElementById('review-address').value = '';
            setRating(0);
            clearPhotos();
        }

        // ==================== РАБОТА С ФОТО ====================
        function handlePhotoUpload(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('photos-preview');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (!file.type.match('image.*')) {
                    showNotification('Можно загружать только изображения', 'error');
                    continue;
                }
                
                if (file.size > 2 * 1024 * 1024) {
                    showNotification(`Изображение ${file.name} слишком большое (макс 2MB)`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const photoData = {
                        id: generateId(),
                        name: file.name,
                        data: e.target.result,
                        preview: URL.createObjectURL(file)
                    };
                    
                    currentState.selectedPhotos.push(photoData);
                    updatePhotosPreview();
                };
                
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }

        function updatePhotosPreview() {
            const previewContainer = document.getElementById('photos-preview');
            previewContainer.innerHTML = '';
            
            currentState.selectedPhotos.forEach((photo, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'photo-preview-item';
                previewItem.innerHTML = `
                    <img src="${photo.preview}" class="photo-preview-img" alt="Предпросмотр">
                    <button class="remove-photo" data-index="${index}">×</button>
                `;
                previewContainer.appendChild(previewItem);
            });
            
            document.querySelectorAll('.remove-photo').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removePhoto(index);
                });
            });
        }

        function removePhoto(index) {
            if (currentState.selectedPhotos[index].preview.startsWith('blob:')) {
                URL.revokeObjectURL(currentState.selectedPhotos[index].preview);
            }
            
            currentState.selectedPhotos.splice(index, 1);
            updatePhotosPreview();
        }

        function clearPhotos() {
            currentState.selectedPhotos.forEach(photo => {
                if (photo.preview.startsWith('blob:')) {
                    URL.revokeObjectURL(photo.preview);
                }
            });
            
            currentState.selectedPhotos = [];
            updatePhotosPreview();
        }

        // ==================== РЕЙТИНГ ====================
        function setRating(value) {
            currentState.selectedRating = value;
            
            const stars = document.querySelectorAll('.star-large');
            const ratingText = document.getElementById('rating-text');
            const texts = [
                "Нажмите на звезду для оценки",
                "Ужасно",
                "Плохо",
                "Нормально",
                "Хорошо",
                "Отлично"
            ];
            
            stars.forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                
                if (starValue <= value) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            ratingText.textContent = texts[value] || texts[0];
        }

        // ==================== ДОБАВЛЕНИЕ ОТЗЫВА ====================
        function addReview() {
            if (!currentState.currentUser) {
                showNotification('Войдите, чтобы оставить отзыв', 'warning');
                openModal('login-modal');
                return;
            }
            
            const reviewText = document.getElementById('review-text').value.trim();
            const reviewAddress = document.getElementById('review-address').value.trim();
            
            if (!reviewText) {
                showNotification('Пожалуйста, введите текст отзыва', 'error');
                return;
            }
            
            if (!reviewAddress) {
                showNotification('Пожалуйста, укажите адрес', 'error');
                return;
            }
            
            if (currentState.selectedRating === 0) {
                showNotification('Пожалуйста, поставьте оценку', 'error');
                return;
            }
            
            const photosData = currentState.selectedPhotos.map(photo => photo.data);
            
            const newReview = {
                id: generateId(),
                category: currentState.category,
                organization: currentState.organization,
                city: currentState.city,
                text: reviewText,
                address: reviewAddress,
                photos: photosData,
                rating: currentState.selectedRating,
                date: new Date().toISOString().split('T')[0],
                user: currentState.currentUser.email,
                status: currentState.currentUser.role === 'admin' ? 'approved' : 'pending'
            };
            
            appData.reviews.push(newReview);
            displayReviews();
            
            document.getElementById('review-text').value = '';
            document.getElementById('review-address').value = '';
            setRating(0);
            clearPhotos();
            
            if (currentState.currentUser.role === 'admin') {
                showNotification('Отзыв добавлен и опубликован', 'success');
            } else {
                showNotification('Спасибо за ваш отзыв! Он будет опубликован после модерации.', 'success');
            }
        }

        // ==================== АДМИН-ПАНЕЛЬ ====================
        function renderAdminPanel() {
            if (!currentState.currentUser || currentState.currentUser.role !== 'admin') {
                showNotification('Доступ запрещен', 'error');
                navigateToLevel('home');
                return;
            }
            
            const adminContent = document.getElementById('admin-panel-content');
            adminContent.innerHTML = `
                <div class="admin-section">
                    <h3><i class="fas fa-users"></i> Управление пользователями</h3>
                    <div class="pending-users">
                        <h4>Ожидают подтверждения:</h4>
                        <div id="pending-users-list">
                            ${appData.pendingUsers.length === 0 ? 
                                '<p>Нет пользователей ожидающих подтверждения</p>' : 
                                appData.pendingUsers.map(user => `
                                    <div class="pending-user-item">
                                        <div>
                                            <strong>${user.email}</strong><br>
                                            <small>Зарегистрирован: ${user.registered}</small>
                                        </div>
                                        <div class="user-actions">
                                            <button class="btn btn-primary approve-user" data-id="${user.id}">
                                                <i class="fas fa-check"></i> Подтвердить
                                            </button>
                                            <button class="btn btn-danger reject-user" data-id="${user.id}">
                                                <i class="fas fa-times"></i> Отклонить
                                            </button>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.level').forEach(level => {
                level.style.display = 'none';
            });
            document.getElementById('level-admin').style.display = 'block';
            
            // Добавляем обработчики для админ-панели
            document.querySelectorAll('.approve-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    approveUser(userId);
                });
            });
            
            document.querySelectorAll('.reject-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    const userId = parseInt(this.getAttribute('data-id'));
                    rejectUser(userId);
                });
            });
        }

        function approveUser(userId) {
            const index = appData.pendingUsers.findIndex(u => u.id === userId);
            if (index !== -1) {
                const user = appData.pendingUsers[index];
                user.status = 'active';
                appData.users.push(user);
                appData.pendingUsers.splice(index, 1);
                renderAdminPanel();
                showNotification('Пользователь подтвержден', 'success');
            }
        }

        function rejectUser(userId) {
            if (confirm('Отклонить регистрацию пользователя?')) {
                const index = appData.pendingUsers.findIndex(u => u.id === userId);
                if (index !== -1) {
                    appData.pendingUsers.splice(index, 1);
                    renderAdminPanel();
                    showNotification('Регистрация пользователя отклонена', 'success');
                }
            }
        }

        // ==================== ОТОБРАЖЕНИЕ ОТЗЫВОВ ====================
        function displayReviews() {
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML = '';
            
            let filteredReviews = appData.reviews.filter(review => {
                return review.category === currentState.category &&
                       review.organization === currentState.organization &&
                       review.city === currentState.city &&
                       review.status === 'approved';
            });
            
            if (currentState.addressFilter) {
                filteredReviews = filteredReviews.filter(review => 
                    review.address.toLowerCase().includes(currentState.addressFilter.toLowerCase())
                );
                
                document.getElementById('address-filter-info').style.display = 'block';
                document.getElementById('current-address-filter').textContent = currentState.addressFilter;
            } else {
                document.getElementById('address-filter-info').style.display = 'none';
            }
            
            if (filteredReviews.length === 0) {
                reviewsList.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-comment-slash"></i> Пока нет отзывов. Будьте первым!
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredReviews.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredReviews.forEach(review => {
                const row = document.createElement('tr');
                
                let photosCell = '<td class="review-photo-cell">-</td>';
                if (review.photos && review.photos.length > 0) {
                    photosCell = `
                        <td class="review-photo-cell">
                            <img src="${review.photos[0]}" class="review-photo-thumb" 
                                 alt="Фото отзыва">
                            ${review.photos.length > 1 ? `<small>+${review.photos.length - 1}</small>` : ''}
                        </td>
                    `;
                }
                
                row.innerHTML = `
                    <td>${review.date}</td>
                    <td>
                        <span class="address-link" data-address="${review.address}">
                            ${review.address}
                        </span>
                    </td>
                    <td>${review.text}</td>
                    ${photosCell}
                    <td class="rating-stars">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</td>
                    <td>${review.user}</td>
                    <td>
                        ${currentState.currentUser && currentState.currentUser.role === 'admin' ? `
                            <button class="btn btn-danger btn-sm delete-review" data-id="${review.id}" style="padding: 5px 10px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                reviewsList.appendChild(row);
            });
            
            document.querySelectorAll('.address-link').forEach(link => {
                link.addEventListener('click', function() {
                    const address = this.getAttribute('data-address');
                    filterByAddress(address);
                });
            });
        }

        function filterByAddress(address) {
            currentState.addressFilter = address;
            displayReviews();
        }
    </script>
</body>
</html>
